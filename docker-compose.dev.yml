version: "3.9"

services:
  snapshot-builder:
    build:
      context: ./services/snapshot-builder
    command: ["npm", "start"]
    environment:
      PORT: 8081
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT:-dev-project}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/credentials/key.json}
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:-$PWD/credentials.json}:/credentials/key.json:ro
    ports:
      - "8081:8081"

  manifest-writer:
    build:
      context: ./services/manifest-writer
    command: ["npm", "start"]
    environment:
      PORT: 8082
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT:-dev-project}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/credentials/key.json}
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:-$PWD/credentials.json}:/credentials/key.json:ro
    ports:
      - "8082:8082"

  index-writer:
    build:
      context: ./services/index-writer
    command: ["npm", "start"]
    environment:
      PORT: 8083
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT:-dev-project}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/credentials/key.json}
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:-$PWD/credentials.json}:/credentials/key.json:ro
    ports:
      - "8083:8083"

  rules-engine:
    build:
      context: ./services/rules-engine
    command: ["npm", "start"]
    environment:
      PORT: 8084
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT:-dev-project}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/credentials/key.json}
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:-$PWD/credentials.json}:/credentials/key.json:ro
    ports:
      - "8084:8084"

  manifest-compactor:
    build:
      context: ./services/manifest-compactor
    command: ["npm", "start"]
    environment:
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT:-dev-project}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/credentials/key.json}
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:-$PWD/credentials.json}:/credentials/key.json:ro
    entrypoint: ["sleep", "infinity"]

networks:
  default:
    name: ecco-dev-net
